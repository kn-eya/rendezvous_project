{% extends "base.html" %}
{% block title %}Réserver Rendez-vous{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Réserver un rendez-vous pour {{ service.name }}</h2>

    <form method="post" class="mt-4">
        {% csrf_token %}

        <!-- Choisir la catégorie -->
        <div class="mb-3">
            <label for="category" class="form-label">Catégorie</label>
            <select name="category" id="category" class="form-select" required>
                <option value="">-- Sélectionner --</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }} - {{ cat.price }} DT</option>
                {% endfor %}
            </select>
        </div>

        <!-- Choisir le prestataire -->
        <div class="mb-3">
            <label for="provider" class="form-label">Prestataire</label>
            <select name="provider" id="provider" class="form-select" required>
                <option value="">-- Sélectionner --</option>
                {% for p in providers %}
                    <option value="{{ p.id }}">{{ p.user.username }} {% if p.city %} ({{ p.city }}) {% endif %}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Date et Heure -->
        <div class="mb-3">
            <label for="date" class="form-label">Date</label>
            <input type="date" name="date" id="date" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="time" class="form-label">Heure</label>
            <input type="time" name="time" id="time" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="notes" class="form-label">Notes (optionnel)</label>
            <textarea name="notes" rows="3" class="form-control"></textarea>
        </div>

        <button type="submit" class="btn btn-success">Réserver</button>
    </form>

    {% if messages %}
        <div class="mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const categorySelect = document.getElementById("category");
    const providerSelect = document.getElementById("provider");

    categorySelect.addEventListener("change", function() {
        const categoryId = this.value;

        if (!categoryId) {
            providerSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
            return;
        }

        // Appel AJAX pour récupérer les prestataires de cette catégorie
        fetch(`/appointments/ajax_get_providers/?category_id=${categoryId}`)
            .then(response => response.json())
            .then(data => {
                providerSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
                data.forEach(p => {
                    const option = document.createElement("option");
                    option.value = p.id;
                    option.textContent = p.name + (p.city ? ` (${p.city})` : '');
                    providerSelect.appendChild(option);
                });
            })
            .catch(err => {
                console.error("Erreur AJAX:", err);
            });
    });
});
</script>

{% endblock %}
